---
title: "Final_project_script"
author: "Maryela C"
format: html
editor: visual
---

## PART 1: Data description

### Data sources:

Growth data were obtained from [**The Forest Macrosystems Network (FMN)**](https://www.forestmacrosystems.org/) project. For this analysis, I focused on the following forest sites:

-   **Niwot Ridge, CO, USA**: A subalpine forest. Growth data were collected during the sampling years 2012, 2013, 2014, 2015, 2016, 2017, 2019, 2020, and 2022.

-   **Barro Colorado Island, Panama**: A tropical seasonal forest. Growth data were collected during the sampling years 2012, 2013, 2014, 2015, and 2016.

Drought data were obtained from the [**SPEI Global Drought Monitor**](https://spei.csic.es/home.html), with a spatial resolution of three months for each site. Only negative SPEI values, which indicate some level of drought, were included in the analysis. The annual average SPEI value was then calculated for each site to represent the drought conditions during the corresponding years.

Further details on data collection methods can be found on the respective website.

### Description of columns:

Load data

```{r}
#Packages
library(readxl)

#data for Niwot Ridge Forest
NWT<- read_excel("01_Cleaning_dataframes/NWT_growthSPEI_cleaned.xlsx")

#data for Barro Colorado Island Forest
BCI<- read_excel("01_Cleaning_dataframes/BCI_growthSPEI_cleaned.xlsx")

```

The forest datasets underwent preliminary cleaning (details available in *01_Cleaning_dataframes*). While the datasets contain numerous columns, the following variables were specifically used for this analysis:

-   **`date.year`**: The year of the observation.

-   **`site`**: The forest name (either Niwot Ridge or Barro Colorado Island).

-   **`plot` / `line`**: Subplot information for each site. Each forest comprises five plots, with each plot containing 10 sampling lines or transects. Both "plot" and "line" are required to maintain homogeneous conditions.

-   **`main`**: A unique identifier for each tree or shrub.

-   **`species_binomial`**: The scientific name of the tree or shrub species.

-   **`SPEI_3`**: The standardized precipitation-evapotranspiration index (SPEI) value with a three-month resolution, representing drought intensity.

-   **`dbh`**: The raw value of diameter at breast height (DBH).

Also created a combined DF, where I'm including both sites

```{r}
#First unified the columns
BCI$dbh <- as.numeric(BCI$dbh)
BCI$SPEI_3 <- as.numeric(BCI$SPEI_3)

#to merge DFs
NWT_BCI <- merge(NWT, BCI, by = c("date.year", "site"), all = TRUE)


```

## PART 2: Scientific goal

The research question of this project is "Are drought seasons reflected on the growth rates?"

In DAG, it would look something like this: drought 窶能> growth , but in a effort to include more variables, I also recognize this relations: year 窶能> drought 窶能> \[ species 窶能> \] growth \<--- site

I hypothesize that tree growth rates will exhibit a significant negative correlation with drought intensity, such that growth rates will decline during years characterized by more severe drought conditions.

## PART 3: Statistical analysis

To test if drought seasons are affecting the growth rates, I conducted a Linear Mixed-Effect Model (LME) per site, where SPEI was use as the fixed effect, and a random effect was included for individual trees and years. Then, I used a LME, where SPEI where a fixed effect and the Forest type was an interaction term, with the same random effects.

It is important to note that using "main" (that is, tree ID) is not the same as "species_binomial", since the first would reflect variability between individuals, and the second, between taxonomic species.

### Pre-statistical analysis settings:

0.  Load necessary library

```{r}
library(Matrix)
library(lme4)
library(lmerTest)
library(forestmangr)
library(dplyr)
library(ggplot2)
```

1.  Check for NA or empty strings on the df

    ```{r}
    #NIWOT RIDGE FOREST
    NWT$dbh <- as.numeric(NWT$dbh)
    head(NWT$dbh)

    #SAME FOR BARRO COLORADO ISLAND
    BCI$dbh <- as.numeric(BCI$dbh)
    head(BCI)

    ```

2.  Used the tree_summarise function from the "forestmangr" package to calculate the equivalent diameter of trees with more than one trunk.

```{r}
#For Niwot Ridge Forest
NWT<-tree_summarise(NWT, #my DF
                    "dbh", #column with size measurements
                    tree="main", #tree id column
                    .groups = c("plot","date.year","site","line")) #parameters to subdivide the estimated dbh


#Same for Barro Colorado Island Forest
BCI<-tree_summarise(BCI, #my DF
                    "dbh", #column with size measurements
                    tree="main", #tree id column
                    .groups = c("plot","date.year","site","line")) #parameters to subdivide the estimated dbh



```

2.  The "growth rate" was subsequently calculated by determining the annual increment in diameter at breast height (DBH). This was achieved by subtracting the DBH value of the previous year from the current year's DBH. While there are established formulas for calculating growth rate with greater precision, this straightforward method was selected for practical purposes in this analysis.

```{r}
#For NWT
NWT_rate <- NWT %>%
  group_by(main) %>%
  arrange(main, date.year) %>%  # Ensure it's sorted by year within each tree
  mutate(growth_rate = c(NA, diff(dbh))) %>%
  ungroup()  # Remove grouping after calculation



#Same for BCI
BCI_rate <- BCI %>%
  group_by(main) %>%
  arrange(main, date.year) %>%  # Ensure it's sorted by year within each tree
  mutate(growth_rate = c(NA, diff(dbh))) %>%
  ungroup()  # Remove grouping after calculation



```

3.  As a tree cannot "decrease", I omitted all negative "growth_rate" values, as this is probably due to measurement error.

    ```{r}
    #FOR NWT
    NWT_rate_c <- NWT_rate_c[NWT_rate_c$SPEI_3 <= 0, ]



    #SAME FOR BCI
    BCI_rate_c <- BCI_rate %>%
      filter(growth_rate >= 0)

    #removed an outlier
    maxBCI_growth_rate_index <- which.max(BCI_rate_c$growth_rate)
    max_growth_rate_row <- BCI_rate_c[max_growth_rate_index, ]
    maxBCI_growth_rate_row <- BCI_rate_c[max_growth_rate_index, ]
    maxBCI_growth_rate_row

    # Overwrite the original dataset with the one that has the row removed
    BCI_rate_clean <- maxBCI_growth_rate_row [-max_growth_rate_index, ]


    ```

4.  Then, merged the two forest

    ```{r}
    # View columns to identify differences
    colnames(NWT_rate_c)
    colnames(BCI_rate_clean)

    # Check if now they have the same columns
    colnames(NWT_rate_c)
    colnames(BCI_rate_clean)

    missing_columns <- setdiff(colnames(NWT_rate_c), colnames(BCI_rate_clean))

    for (col in missing_columns) {
        BCI_rate_clean[[col]] <- NA }


    BCI_rate_c <- BCI_rate_clean[, colnames(NWT_rate_c)]

    extra_columns <- setdiff(colnames(BCI_rate_clean), colnames(NWT_rate_c))
    BCI_rate_c <- BCI_rate_c[, !(colnames(BCI_rate_c) %in% extra_columns)]

    # Merge the data frames
    NWTxBCI_rate <- rbind(NWT_rate_c, BCI_rate_clean)


    ```

### LME for Niwot Ridge

Model 1 was the simplest and the one that best fit the data (lower REML). This suggests a weak positive relationship between drought and growth rate (Estimate=0.036 , p-value=0.069).

Notice that I also tried others models, such as:

-   Model 2: growth_rate \~ SPEI + (1 \| species_binomial)

    -   The REML (31674.1) was higher than Model 1, but the difrection of the effect was the same: positive relationship between SPEI and growth rate.

-   Model 3: growth_rate \~ SPEI + (1 \| species_binomial) + ( 1 \| year)

    -   REML (31673.1) higher than Model 1 but similar to Model 2.

-   Model 4: growth_rate \~ SPEI + ( 1 \| tree tag) + (1 \| year)

    -   REML (30871.6) lower tan Model 1, but p-value suggested no evidence for a relationship between drought and growth.

```{r}
#Here I'm showing MODEL 1
NWT_lme<- lmer(growth_rate ~ SPEI_3 + (1 | main) , data = NWT_rate_c)

summary(NWT_lme)


```

### LME for Barro Colorado Island

Model 3 was the one that best fit the data (lower REML). This suggest that the species and the year are both explaining the variation in growth (Estimate=0.036 , p-value=0.018).

Notice that I also tried others models, such as:

-   Model 1: growth_rate \~ SPEI + ( 1 \| tree tag)

    -   REML (13,503.8) lower than Model 3, but p-value (0.891) indicates no significant result.

-   Model 2: growth_rate \~ SPEI + ( 1 \| species_binomial)

    -   REML (24,381.7) higher than the rest of the models.

-   Model 4: growth_rate \~ SPEI + ( 1 \| main) + (1 \| year)

    -   REML (13503.8) same as Model 1, but the variance for year in here is 0, probably becaue of a redundancy with the SPEI.

```{r}
#Here I'm showing model 3
BCI_lme<- lmer(growth_rate ~ SPEI_3 + (1 | species_binomial) + (1|date.year), data = BCI_rate_clean)

summary(BCI_lme)

```

### LME for both forest

Model 2, despite not being the lowest REML, is the one that fits best (lower residual variance), and it stands out that the site effect is significant (p = 0.00153), but neither SPEI nor the interaction term is significant.

-   Model 1: growth_rate \~ SPEI \* site + ( 1 \| species )

    -   REML (56543.3); this model suggests that the species are a main factor influencing the growth rate.

-   Model 2: growth_rate \~ SPEI \* site + (1 \| main)

    -   REML (50951.4) lower than Model 1, as well as lower residual variance. The tree ID (main) as a grouping variable is worse than Model 1.

-   Model 3: growth_rate \~ SPEI + dbh + (1 \| species )

    -   REML: 54499; The result is not statistically significant (p=0.0952).

-   Model 4: growth_rate \~ SPEI \* site + dbh + (1 \| species )

    -   REML (54491) slightly lower than Model 3; The interaction between SPEI and site is significant, indicating that the effect of drought on growth rate differs between sites.

-   Model 5: growth_rate \~ SPEI_3 + site + dbh + (1 \| main)

    -   Second lowest REML (49619); SPEI in here is not explaining variation in growth rates

-   Model 6: growth_rate \~ SPEI + site + dbh + (1 \| year )

    -   REML: 54771.4; SPEI is significant in here, suggesting that drought has a measurable effect on growth rates.

-   Model 7: growth_rate \~ SPEI \* site + dbh + (1 \| year ) + (1\| species) + (1\|tree ID)

    -   Lowest REML (49563.7) but least parsimonious (over-parameterization)

```{r}
NWTxBCI_lme <- lmer(growth_rate ~ SPEI_3 * site + dbh + (1|species_binomial) + (1|main) + (1 | date.year), data = NWTxBCI_rate)


summary(NWTxBCI_lme)
```

## PART 4: Results interpretation

Niwot Ridge

RAW DATA: plot per species

```{r}
NWT_rate_c$predicted_growth <- NA  
complete_rows <- complete.cases(NWT_rate_c[, c("date.year", "site", "plot", "census.year", "line", "main", "enq", "species_binomial", "family", "morpho", "habit", "site_id", "SPEI_3", "dbh", "vwb", "vwob", "growth_rate")])

NWT_rate_c$predicted_growth[complete_rows] <- predict(NWT_lme, newdata = NWT_rate_c[complete_rows, ])


# Filter the data
NWT_rate_c_filtered <- NWT_rate_c %>%
  filter(SPEI_3 <= 0, species_binomial != "unidentified_NWT")

# Create the plot
ggplot(NWT_rate_c_filtered, aes(x = SPEI_3, y = growth_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  facet_wrap(~ species_binomial) +  # Create separate plots for each species
  labs(x = "SPEI (Drought Severity)", y = "Growth Rate") +
  theme_minimal() +
  ggtitle("Growth Rate vs. SPEI by Species")




```

RAW DATA: plot per site. Applied a log transformation to compress the high range of growth rate

```{r}
ggplot(NWT_rate_c_filtered_no_outliers, aes(x = SPEI_category, y = log_growth_rate, color = SPEI_category)) +
  geom_violin(trim = TRUE, alpha = 0.7) +
  labs(x = "SPEI Category (Drought Severity)", y = "Log Growth Rate") +
  scale_y_continuous(breaks = seq(0, max(NWT_rate_c_filtered_no_outliers$log_growth_rate), by = 1.5)) +  # Adjust y-axis breaks
  theme_minimal() +
  ggtitle("Log Growth Rate Distribution by SPEI Categories (No Outliers)")




```

another plot idea

```{r}
ggplot(NWT_rate_c_filtered_no_outliers, aes(x = SPEI_3, y = log_growth_rate, color = SPEI_category)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(x = "SPEI (Drought Severity)", y = "Log Growth Rate") +
  theme_minimal() +
  ggtitle("Log Growth Rate vs. SPEI (Drought Severity) with Trend Line")






```

Graph for Model 1

```{r}
NWT_rate_c$predicted_growth <- predict(NWT_lme, newdata = NWT_rate_c, allow.new.levels = TRUE)
# Check levels of the grouping variable in new data
levels(NWT_rate_c$site)  # Check that the levels are the same as in the model
# Remove rows with missing values
NWT_rate_c_no_na <- NWT_rate_c[complete.cases(NWT_rate_c), ]
NWT_rate_c_no_na$predicted_growth <- predict(NWT_lme, newdata = NWT_rate_c_no_na)



ggplot(NWT_rate_c, aes(x = SPEI_3, y = growth_rate)) +
  geom_point(alpha = 0.5, color = "black") +  # Data points in grey with some transparency
  geom_smooth(method = "loess", aes(y = growth_rate), color = "red", size = 1, se = TRUE) +  # Flexible trend line with CI
  labs(x = "SPEI (Drought Severity)", y = "Growth Rate") +
  theme_minimal() +
  ggtitle("Growth Rate vs. SPEI with Model Prediction and Trend Line") +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title

```

BCI RAW DATA: impossible to read

```{r}
BCI_rate_c$predicted_growth <- NA  
complete_rows <- complete.cases(BCI_rate_c[, c("date.year", "site", "plot", "census.year", "line", "main", "enq", "species_binomial", "family", "morpho", "habit", "site_id", "SPEI_3", "dbh", "vwb", "vwob", "growth_rate")])

BCI_rate_c$predicted_growth[complete_rows] <- predict(BCI_lme, newdata = BCI_rate_c[complete_rows, ])


# Filter the data
BCI_rate_c_filtered <- BCI_rate_c %>%
  filter(SPEI_3 <= 0, species_binomial != "unidentified_BCI")

# Create the plot
ggplot(BCI_rate_c_filtered, aes(x = SPEI_3, y = growth_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "orange") +
  facet_wrap(~ species_binomial) +  # Create separate plots for each species
  labs(x = "SPEI (Drought Severity)", y = "Growth Rate") +
  theme_minimal() +
  ggtitle("Growth Rate vs. SPEI by Species")
```

raw data per site

```{r}
ggplot(BCI_rate_c, aes(x = SPEI_3, y = growth_rate)) +
  geom_point(alpha = 0.5) +  # Points
  geom_smooth(method = "lm", color = "orange", se = FALSE) +  # Linear regression line
  labs(x = "SPEI (Drought Severity)", y = "Growth Rate") +
  theme_minimal() +
  ggtitle("Growth Rate vs. SPEI (Drought Severity)")

```

BCI MODEL

```{r}
# Load necessary libraries
library(ggplot2)
library(lme4)

# Get the predictions from the model (fixed effects only)
BCI_rate_c$predicted_growth <- predict(BCI_lme, newdata = BCI_rate_c, re.form = NA)

# Plot the observed vs predicted growth rates
ggplot(BCI_rate_c, aes(x = predicted_growth, y = growth_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  labs(title = "Observed vs Predicted Growth Rates",
       x = "Predicted Growth Rate",
       y = "Observed Growth Rate") +
  theme_minimal()

# Now plot the effect of 'SPEI_3' on 'growth_rate'
ggplot(BCI_rate_c, aes(x = SPEI_3, y = growth_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(title = "Effect of SPEI_3 on Growth Rate",
       x = "SPEI_3", 
       y = "Growth Rate") +
  theme_minimal()

```

BOTH RAW DATA

```{r}
# Assuming you have a column 'site' with values 'Niwot Ridge' and 'Barro Colorado Island'
ggplot(NWTxBCI_rate, aes(x = SPEI_3, y = growth_rate)) +
  geom_point(aes(color = site), alpha = 0.6) +
  scale_color_manual(values = c("Niwot Ridge LTER" = "blue", "Barro Colorado Island" = "red")) +
  labs(title = "Growth Rate vs SPEI_3 by Site", 
       x = "SPEI_3", 
       y = "Growth Rate") +
  theme_minimal() +
  theme(legend.position = "bottom")



```

model for both sites together

```{r}
# Filter out non-finite values from the SPEI_3 column
NWTxBCI_rate_clean <- NWTxBCI_rate[is.finite(NWTxBCI_rate$SPEI_3), ]

# Create the new data frame for predictions
new_data <- expand.grid(
  SPEI_3 = seq(min(NWTxBCI_rate_clean$SPEI_3), max(NWTxBCI_rate_clean$SPEI_3), length.out = 100),  # Range of SPEI_3
  site = unique(NWTxBCI_rate_clean$site),
  dbh = mean(NWTxBCI_rate_clean$dbh, na.rm = TRUE)  # Mean DBH for consistency
)

# Make predictions from the linear mixed model
new_data$predicted_growth_rate <- predict(NWTxBCI_lme, newdata = new_data, re.form = NA)

# Plotting the interaction between SPEI_3 and site
ggplot(new_data, aes(x = SPEI_3, y = predicted_growth_rate, color = site)) +
  geom_line(size = 1.2) + 
  labs(title = "Predicted Growth Rate vs SPEI_3 by Site", 
       x = "SPEI_3", 
       y = "Predicted Growth Rate", 
       color = "Site") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("blue", "red"))  # Customize colors for the sites


```

```{r}
# Plot the raw data with smoothed tendency but clipped to avoid negative values
ggplot(NWTxBCI_rate_clean, aes(x = SPEI_3, y = growth_rate, color = site)) +
  geom_point(alpha = 0.3) +  # Raw data points
  geom_smooth(method = "loess", se = FALSE, size = 1.2) +  # Smoothing line
  labs(title = "Raw Data: Growth Rate vs SPEI_3 by Site", 
       x = "SPEI_3", 
       y = "Growth Rate", 
       color = "Site") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("blue", "red")) +
  coord_cartesian(ylim = c(0, NA))  # Limit y-axis to start from 0


```

## Supplementary material
